---
- name: Setup user 'pcc' on remote host
  hosts: all
  gather_facts: false
  become: true
  vars:
    public_ssh_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCtHEZ2XNgOdNkABonoj49y8SMGMQtUbGNhglUyGlKf1ll4N5ha5iNTLSjRtuNhF2f6JZssB/94+LhkoiEXLJ5QuhWO+vcO3ZjL43TzYLnI4BP4hsGc+TDGhDALq/XbYblyAukQttn4qHVPlCYxR7MJJj2dorwPZHsYZ6B7fWR869uF7ZkV/XRWq4bbvvKadQeqzS63mjrmLFJ6/rMLfO5XtXEYwgVNMcxhsRC1DPm2oeWAgpGYlMoMYK0PYVmbFGQlQ3+UWa2KuG9tojdYruD2YD1yT5aKYsIKra61lqxWMPfGsuvXnFLl4jgHSYYqbEV1DjQpCWr3qNIvhbuB6nUtZxYkCsDZveNs8Wz7Q3Dc1a6mLy6MV9+UdvJyd8+3N6HFF62pR83mrRbhmKQbBEBFQ6nJCGQi8JrQuFP2aY2A/s0bQ4pbilkJO+8TkG8JkFtgyZIb8bPRB1LU7GpXV82fjq+n0BiV1V+Dxav5Ux4w4Bb6jkBTJJkZx3WAyirtFak= pcc@B020211-66f52a4f3b4c"
    user_to_add: "pcc"

  tasks:

    - name: Show network interfaces
      ansible.builtin.command: ip a
      register: ip_output

    - name: Print network interfaces
      ansible.builtin.debug:
        var: ip_output.stdout_lines

    - name: "Ensure user {{ user_to_add }} exists"
      ansible.builtin.user:
        name: "{{ user_to_add }}"
        shell: /bin/bash
        create_home: true

    - name: "Allow {{ user_to_add }} passwordless sudo"
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ user_to_add }}"
        content: "{{ user_to_add }} ALL=(ALL) NOPASSWD:ALL\n"
        mode: '0440'

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "/home/{{ user_to_add }}/.ssh"
        state: directory
        owner: "{{ user_to_add }}"
        group: "{{ user_to_add }}"
        mode: '0700'

    - name: "Add authorized key for {{ user_to_add }}"
      ansible.builtin.authorized_key:
        user: "{{ user_to_add }}"
        key: "{{ public_ssh_key }}"
        state: present
